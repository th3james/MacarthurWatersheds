(function(){window.MacArthur||(window.MacArthur={}),MacArthur.CONFIG={tabs:[{selector:"now",name:"Now"},{selector:"change",name:"Change"},{selector:"future_threats",name:"Future Threats"}],regions:[{code:"WAN",name:"Andes",bounds:[[-22,-57],[14,-83]]},{code:"GLR",name:"African Great Lakes",bounds:[[-18,30],[10,40]]},{code:"MEK",name:"Mekong",bounds:[[6,110],[35,90]]}],subjects:[{selector:"biodiversity",name:"Biodiversity importance"},{selector:"ecosystem",name:"Ecosystem function"}],lenses:{biodiversity:[{selector:"allsp",name:"All species","default":!0},{selector:"crenvu",name:"All threatened"},{selector:"amphibia",name:"Amphibians"},{selector:"mammalia",name:"Mammals"},{selector:"aves",name:"Birds"}],ecosystem:[{selector:"totef",name:"Total EF provision","default":!0},{selector:"comprov",name:"Commodity provision (cultivated products)"},{selector:"wildprov",name:"Wild provision"},{selector:"regprov",name:"Regulating functions provision"}]},scenarios:[{selector:"mf2050",name:"Markets first"},{selector:"susf2050",name:"Sustainability first"},{selector:"secf2050",name:"Security first"},{selector:"polf2050",name:"Policy first"}],levels:{"default":[{selector:"all",name:"All","default":!0},{selector:"high",name:"High"},{selector:"medium",name:"Medium"},{selector:"low",name:"Low"}],change:[{selector:"all",name:"All","default":!0},{selector:"increase",name:"Increase"},{selector:"low",name:"Low"},{selector:"medium",name:"Medium"},{selector:"high",name:"High"}]},protectionLevels:[{selector:"all",name:"Completely covered by PAâ€™s","default":!0},{selector:"high",name:"Up to three thirds covered"},{selector:"medium",name:"Up to two thirds covered"},{selector:"low",name:"Up to one third covered"}],pressureLevels:[{selector:"high",name:"High","default":!0},{selector:"medium",name:"Medium"},{selector:"low",name:"Low"}],agrCommDevLevels:[{selector:"all",name:"All","default":!0},{selector:"high",name:"High"},{selector:"medium",name:"Medium"},{selector:"low",name:"Low"},{selector:"negative",name:"Decrease"}]},MacArthur.getFilterOptionsWithSelectedSet=function(e,t,r){var i;return i=r||""+t+"s",_.map(MacArthur.CONFIG[i],function(r){return r.active=e.get(t)===r.selector?!0:!1,r})}}).call(this),function(){var e,t={}.hasOwnProperty,r=function(e,r){function i(){this.constructor=e}for(var n in r)t.call(r,n)&&(e[n]=r[n]);return i.prototype=r.prototype,e.prototype=new i,e.__super__=r.prototype,e};(e=window.Backbone).Models||(e.Models={}),window.Backbone.Models.Filter=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.defaults={tab:"now"},t}(Backbone.Model)}.call(this),function(){var e,t={}.hasOwnProperty,r=function(e,r){function i(){this.constructor=e}for(var n in r)t.call(r,n)&&(e[n]=r[n]);return i.prototype=r.prototype,e.prototype=new i,e.__super__=r.prototype,e};(e=window.Backbone).Models||(e.Models={}),window.Backbone.Models.ResultsNumber=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.defaults={number:0},t}(Backbone.Model)}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};window.MacArthur||(window.MacArthur={}),window.MacArthur.QueryBuilder=function(){function t(t){this.filter=t,this.updateFilterQuery=e(this.updateFilterQuery,this),this.filter.on("change",this.updateFilterQuery)}return t.prototype.buildQuery=function(){var e;return this.hasRequiredFilters()?(e=this.filter.get("region").get("code"),"SELECT DISTINCT d.watershed_id, d.value, percentage as protection_percentage,\npressure.value as pressure_index "+this.includeComprovValueClause()+",\nw.name, w.lake \nFROM macarthur_region r \nRIGHT JOIN macarthur_watershed w ON r.cartodb_id = w.region_id \nLEFT JOIN macarthur_datapoint d ON d.watershed_id = w.cartodb_id \nLEFT JOIN macarthur_lens lens ON lens.cartodb_id = d.lens_id \nLEFT JOIN macarthur_protection p ON p.watershed_id = w.cartodb_id \nLEFT JOIN macarthur_pressure pressure \nON pressure.watershed_id = w.cartodb_id \n"+this.buildComprovValueClause()+" \nWHERE r.code = '"+e+"' \nAND "+this.buildSubjectClause()+" \nAND "+this.buildLensClause()+"\nAND "+this.buildMetricClause()+" \nAND "+this.buildScenarioClause()+" \nAND type_data = 'value'"):this.filter.get("query")},t.prototype.includeComprovValueClause=function(){return"future_threats"===this.filter.get("tab")?", comprov_value ":" "},t.prototype.buildComprovValueClause=function(){return"future_threats"===this.filter.get("tab")?"LEFT JOIN (\nSELECT d.watershed_id, d.value AS comprov_value FROM \nmacarthur_datapoint d \nLEFT JOIN macarthur_lens lens ON lens.cartodb_id = d.lens_id \nWHERE lens.type = 'comprov' AND metric = 'change' \nAND "+this.buildScenarioClause("comprov")+" AND type_data = 'value' ) s \nON s.watershed_id = d.watershed_id ":""},t.prototype.buildSubjectClause=function(){var e,t,r;if(t=this.filter.get("subject"),r={biodiversity:"bd",ecosystem:"ef"},e=r[t],null==e)throw new Error("Error building query, unknown subject '"+t+"'");return"lens.name = '"+e+"' "},t.prototype.buildScenarioClause=function(e){var t,r;return t=this.filter.get("scenario"),r=this.filter.get("tab"),"future_threats"===r?"comprov"===e?"scenario = '"+t+"' ":"scenario = 'bas' ":null!=t?"scenario = '"+t+"' ":"scenario = 'bas' "},t.prototype.buildLensClause=function(){var e;return e=this.filter.get("lens"),"lens.type = '"+e+"' "},t.prototype.buildMetricClause=function(){var e;return e=this.filter.get("tab"),"change"===e?"metric = 'change' ":"metric = 'imp' "},t.prototype.hasLens=function(e,t){return"future_threats"===this.filter.get("tab")?!0:null!=_.find(MacArthur.CONFIG.lenses[e],function(){return function(e){return e.selector===t}}(this))},t.prototype.hasRequiredFilters=function(){var e,t;return t=this.filter.get("subject"),e=this.filter.get("lens"),null!=t&&null!=e?this.hasLens(t,e):!1},t.prototype.isFromProtection=function(){return null!=this.filter.changedAttributes().protection||null!=this.filter.changedAttributes().protection_levels},t.prototype.isFromPressure=function(){return null!=this.filter.changedAttributes().pressure||null!=this.filter.changedAttributes().pressure_levels},t.prototype.tabLacksSelections=function(){var e,t,r,i;return i=this.filter.get("tab"),"now"===i||"future_threats"===i?!1:(t=this.filter.get("scenario"),r=this.filter.get("subject"),e=this.filter.get("lens"),null!=r&&null!=e&&null!=t?!1:!0)},t.prototype.updateFilterQuery=function(){return null!=this.filter.changedAttributes().query||this.isFromProtection()||this.isFromPressure()||this.tabLacksSelections()?void 0:this.filter.set("query",this.buildQuery(this.filter))},t}()}.call(this),function(){var e,t,r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Models||(e.Models={}),(t=window.Backbone).Collections||(t.Collections={}),Backbone.Models.Region=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return i(t,e),t}(Backbone.Model),Backbone.Collections.RegionCollection=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return i(t,e),t.prototype.model=Backbone.Models.Region,t}(Backbone.Collection)}.call(this),function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}},r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.TabView=function(e){function r(){return this.setTab=t(this.setTab,this),r.__super__.constructor.apply(this,arguments)}return i(r,e),r.prototype.template=Handlebars.templates.tab,r.prototype.events={"click ul.tabs li":"setTab"},r.prototype.initialize=function(e){return this.config=_.cloneDeep(MacArthur.CONFIG.tabs),this.filter=e.filter,this.resultsNumber=e.resultsNumber,this.render()},r.prototype.render=function(){var e;return e=MacArthur.getFilterOptionsWithSelectedSet(this.filter,"tab"),this.$el.html(this.template({thisView:this,filter:this.filter,resultsNumber:this.resultsNumber,tabs:e})),this.attachSubViews(),this},r.prototype.onClose=function(){},r.prototype.setTab=function(e){var t;return t=$(e.target).attr("data-subject"),t!==this.filter.get("tab")?(this.resetFilters(),this.filter.set("tab",t),this.render()):void 0},r.prototype.resetFilters=function(){return this.filter.unset("subject"),this.filter.unset("lens"),this.filter.unset("scenario"),this.filter.unset("level"),this.filter.unset("agrCommDevLevel"),this.filter.unset("protection"),this.filter.unset("protectionLevel"),this.filter.unset("pressure"),this.filter.unset("pressureLevel")},r}(Backbone.Diorama.NestingView)}.call(this),function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}},r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.BaseSelectorView=function(e){function r(){return this.isChangeTab=t(this.isChangeTab,this),this.setDefaultLevel=t(this.setDefaultLevel,this),r.__super__.constructor.apply(this,arguments)}return i(r,e),r.prototype.initialize=function(e){return this.filter=e.filter},r.prototype.render=function(){var e,t;return e=_.map(this.config,function(e){return function(t){return t.selected=e.filter.get(e.levelType)===t.selector?!0:!1,t}}(this)),this.$el.html(this.template({levels:e,isChangeTab:this.isChangeTab})),t=this.$el.find(".select-box"),setTimeout(function(e){return function(){return t.customSelect(),e.$el.find(".customSelectInner").css({width:"100%"})}}(this),20)},r.prototype.setLevel=function(e){var t;return t=$(e.target).find(":selected").attr("value"),this.filter.set(this.levelType,t)},r.prototype.setDefaultLevel=function(){return this.filter.set(this.levelType,this.getDefaultFilter().selector)},r.prototype.getDefaultFilter=function(){return _.find(this.config,function(e){return null!=e["default"]})},r.prototype.isChangeTab=function(){return"change"===this.filter.get("tab")},r}(Backbone.View)}.call(this),function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}},r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.MapView=function(e){function r(){return this.queryPolyStyle=t(this.queryPolyStyle,this),this.baseLineStyle=t(this.baseLineStyle,this),this.getFillOpacity=t(this.getFillOpacity,this),this.setPressureFill=t(this.setPressureFill,this),this.setAgrCommDevFill=t(this.setAgrCommDevFill,this),this.setProtectionFill=t(this.setProtectionFill,this),this.filterFeatureLevel=t(this.filterFeatureLevel,this),this.getColor=t(this.getColor,this),this.resetQueryLayerStyle=t(this.resetQueryLayerStyle,this),this.updateQueryLayerStyle=t(this.updateQueryLayerStyle,this),this.buildQuerydata=t(this.buildQuerydata,this),this.setMinMax=t(this.setMinMax,this),this.updateQueryLayer=t(this.updateQueryLayer,this),this.bindPopup=t(this.bindPopup,this),this.unsetLegend=t(this.unsetLegend,this),this.setLegend=t(this.setLegend,this),r.__super__.constructor.apply(this,arguments)}return i(r,e),r.prototype.template=Handlebars.templates.map,r.prototype.colorRange={change:["#FF5C26","#eee","#A3D900"],now:["#FFDC73","#FF5C26"],future_threats:["#FFDC73","#FF5C26"]},r.prototype.legendText={change:["Decrease","Increase"],now:["Low","High"],future_threats:["Low","High"]},r.prototype.initialize=function(e){return this.filter=e.filter,this.resultsNumber=e.resultsNumber,this.initBaseLayer(),this.listenTo(this.filter,"change:tab",this.resetQueryLayerStyle),this.listenTo(this.filter,"change:query",this.updateQueryLayer),this.listenTo(this.filter,"change:level",this.updateQueryLayerStyle),this.listenTo(this.filter,"change:protectionLevel",this.updateQueryLayerStyle),this.listenTo(this.filter,"change:pressureLevel",this.updateQueryLayerStyle),this.listenTo(this.filter,"change:agrCommDevLevel",this.updateQueryLayerStyle)},r.prototype.sortDataBy=function(e,t){return _.map(_.sortBy(e,t),function(e,t){return e.rank=t,e})},r.prototype.setZeroValueIndex=function(){return this.zeroValueIndex=_.findIndex(this.sortDataBy(this.data,"value"),function(e){return e.value>=0})},r.prototype.initBaseLayer=function(){return this.mapHasData=!1,this.lineWeight=d3.scale.linear().domain([0,11]).range([.5,2.6]),this.map=L.map("map",{scrollWheelZoom:!0}).setView([0,0],3),this.queryUrlRoot="https://carbon-tool.cartodb.com/tiles/macarthur_watershed/{z}/{x}/{y}.png?",L.tileLayer("https://a.tiles.mapbox.com/v3/timwilki.himjd69g/{z}/{x}/{y}.png",{attribution:'Mapbox <a href="http://mapbox.com/about/maps" target="_blank">Terms & Feedback</a>'}).addTo(this.map)},r.prototype.initQueryLayer=function(e,t){var r,i;return this.region=t,i=t.get("code"),r=t.get("bounds"),this.categories=3,this.resetWatershedSelectionCount(),this.collection=topojson.feature(e,e.objects[i]),this.interiors=topojson.mesh(e,e.objects[i]),this.queryLayer=L.geoJson(this.collection,{style:this.basePolyStyle}).addTo(this.map),this.queryLayerInteriors=L.geoJson(this.interiors,{style:this.baseLineStyle}).addTo(this.map),this.queryLayer,this.map.fitBounds(r),this.map.on("zoomend",function(e){return function(){return e.queryLayerInteriors.setStyle(e.baseLineStyle)}}(this))},r.prototype.getLegendGradientElement=function(e){var t,r,i;return Modernizr.cssgradients?(t=_.cloneDeep(this.colorRange[e]),r=t.join(", "),i="linear-gradient(to right, "+r+");","<div class='map-legend-gradient' style='background: "+i+"'>"):"<div class='map-legend-gradient nogradient "+e+"'>"},r.prototype.setLegend=function(){return this.legend&&this.unsetLegend(),this.legend=L.control({position:"bottomleft"}),this.legend.onAdd=function(e){return function(){var t,r,i;return t=L.DomUtil.create("div","info legend"),r=e.filter.get("tab"),i="change"===r?"change":"importance",t.innerHTML="<div class='map-legend-text'>\n  <h3 class='legend-title'>Level of "+i+"</h3>\n</div>\n  "+e.getLegendGradientElement(r)+"\n  <span>"+e.legendText[r][0]+"</span>\n  <span>"+e.legendText[r][1]+"</span>          \n</div>",t}}(this),this.legend.addTo(this.map)},r.prototype.unsetLegend=function(){return this.legend&&this.legend.removeFrom(this.map),this.legend=!1},r.prototype.bindPopup=function(e,t){var r,i,n;return r=t.feature.properties.cartodb_id,n=_.find(this.data,function(e){return e.watershed_id===r}),i={maxWidth:200},t.bindPopup("Watershed id: "+n.name+" <br>\nValue: "+this.formatToFirst2NonZeroDecimals(n.value)+" <br>\nPressure Index: "+this.formatToFirst2NonZeroDecimals(n.pressure_index)+" <br>\nProtection Percentage: "+n.protection_percentage.toFixed(0)+" <br>\n<a href='data/data_sheets/"+n.name+".pdf'>Watershed data sheet</a>",i)},r.prototype.updateQueryLayer=function(){var e;return this.map.removeLayer(this.queryLayer),this.styleValueField="rank",e=this.filter.get("query"),null!=e?$.getJSON("https://carbon-tool.cartodb.com/api/v2/sql?q="+e+"&callback=?",function(e){return function(t){if(e.data=e.sortDataBy(t.rows,"value"),!(e.data.length>0))throw new Error("Data should not be empty, check your query");return e.setMinMax(),"change"===e.filter.get("tab")&&e.setZeroValueIndex(),e.querydata=e.buildQuerydata(e.data),e.resetWatershedSelectionCount(e.data.length),e.queryLayer=L.geoJson(e.collection,{style:e.queryPolyStyle,onEachFeature:e.bindPopup}).addTo(e.map),e.mapHasData||(e.mapHasData=!0,e.queryLayerInteriors.setStyle(e.baseLineStyle)),e.queryLayerInteriors.bringToFront(),e.setLegend()}}(this)):void 0},r.prototype.setMinMax=function(){return this.max={value:this.data[this.data.length-1].value,rank:this.data.length,agrCommDev:_.max(this.data,function(e){return e.comprov_value}).comprov_value},this.min={value:this.data[0].value,rank:0,agrCommDev:0},this},r.prototype.buildQuerydata=function(e){return _.object(_.map(e,function(){return function(e){return[e.watershed_id,{rank:e.rank,value:e.value,protectionPercentage:e.protection_percentage,pressureIndex:e.pressure_index,agrCommDevValue:e.comprov_value||"",watershed_name:e.name,lake:e.lake||!1}]}}(this)))},r.prototype.updateQueryLayerStyle=function(){if(null!=this.querydata){if(this.resetWatershedSelectionCount(),this.queryLayer.setStyle(this.queryPolyStyle),this.resultsNumber.set("number",this.currentSelectionCount),0===this.currentSelectionCount)return this.unsetLegend();if(!this.legend)return this.setLegend()}},r.prototype.resetQueryLayerStyle=function(){return this.queryLayer.setStyle(this.basePolyStyle)},r.prototype.getColor=function(e){var t,r,i,n;return n=this.filter.get("tab"),"change"===n?(r=[this.min[this.styleValueField],this.zeroValueIndex,this.max[this.styleValueField]],i=this.colorRange[n]):(r=[this.min[this.styleValueField],this.max[this.styleValueField]],i=this.colorRange[n]),(t=d3.scale.linear().domain(r).range(i))(this.querydata[e][this.styleValueField])},r.prototype.filterFeatureLevel=function(e){var t,r,i,n;return r=this.filter.get("level"),n=this.filter.get("tab"),t=this.querydata[e],i="change"===n?this.zeroValueIndex/this.categories:(this.max[this.styleValueField]-this.min[this.styleValueField])/this.categories,"all"===r?!0:"increase"===r?t[this.styleValueField]>=this.zeroValueIndex:"high"===r&&"change"!==n&&t[this.styleValueField]>=this.min[this.styleValueField]+2*i?!0:"low"===r&&"change"===n&&t[this.styleValueField]>=this.min[this.styleValueField]+2*i&&t[this.styleValueField]<this.zeroValueIndex?!0:"medium"===r&&t[this.styleValueField]>=this.min[this.styleValueField]+i&&t[this.styleValueField]<this.min[this.styleValueField]+2*i?!0:("low"===r&&"change"!==n||"high"===r&&"change"===n)&&t[this.styleValueField]>=this.min[this.styleValueField]&&t[this.styleValueField]<this.min[this.styleValueField]+i?!0:!1},r.prototype.setProtectionFill=function(e,t){var r;return r=this.filter.get("protectionLevel"),"all"===r&&100!==t.protectionPercentage&&(e=0),"high"===r&&(t.protectionPercentage>=66&&t.protectionPercentage<100||(e=0)),"medium"===r&&(t.protectionPercentage>=33&&t.protectionPercentage<66||(e=0)),"low"===r&&(t.protectionPercentage<33||(e=0)),e},r.prototype.setAgrCommDevFill=function(e,t){var r,i,n;return r=this.filter.get("agrCommDevLevel"),i=this.min.agrCommDev,t=t.agrCommDevValue,n=(this.max.agrCommDev-i)/this.categories,"high"===r&&(t>=i+2*n||(e=0)),"medium"===r&&(t>=i+n&&i+2*n>t||(e=0)),"low"===r&&(t>=i&&i+n>t||(e=0)),"negative"===r&&(0>t||(e=0)),e},r.prototype.setPressureFill=function(e,t){var r;return r=this.filter.get("pressureLevel"),"high"===r&&(t.pressureIndex>=.66||(e=0)),"medium"===r&&(t.pressureIndex>=.33&&t.pressureIndex<.66||(e=0)),"low"===r&&(t.pressureIndex<.33||(e=0)),e},r.prototype.getFillOpacity=function(e){var t,r;return r=.9,t=this.querydata[e],this.filter.get("protection")===!0&&(r=this.setProtectionFill(r,t)),this.filter.get("pressure")===!0&&(r=this.setPressureFill(r,t)),null!=this.filter.get("agrCommDevLevel")&&(r=this.setAgrCommDevFill(r,t)),.9===r&&(this.currentSelectionCount+=1),r},r.prototype.baseLineStyle=function(){return{weight:this.lineWeight(this.map.getZoom()),opacity:.5,color:this.mapHasData?"#222":"#C0A972",fillOpacity:0}},r.prototype.basePolyStyle=function(){return{weight:0,opacity:0,fillOpacity:.25,color:"#C0A972"}},r.prototype.queryPolyStyle=function(e){var t,r,i;return i=e.properties.cartodb_id,this.filterFeatureLevel(i)?(r=this.getFillOpacity(i),t=this.getColor(i)):(r=0,t=0),{weight:0,opacity:0,fillOpacity:e.properties.lake?0:r,fillColor:t}},r.prototype.resetWatershedSelectionCount=function(e){return e||(e=0),this.currentSelectionCount=e,this.resultsNumber.set("number",e)},r.prototype.formatToFirst2NonZeroDecimals=function(e){return e+="",e.match(/^-{0,1}[0-9]+\.*0*[1-9]{0,2}/)},r.prototype.onClose=function(){return this.remove()},r}(Backbone.View)}.call(this),function(){var e,t={}.hasOwnProperty,r=function(e,r){function i(){this.constructor=e}for(var n in r)t.call(r,n)&&(e[n]=r[n]);return i.prototype=r.prototype,e.prototype=new i,e.__super__=r.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.ResultsNumberView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.template=Handlebars.templates.results_number,t.prototype.initialize=function(e){return this.resultsNumber=e.resultsNumber,this.listenTo(this.resultsNumber,"change:number",this.render),this.render()},t.prototype.render=function(){return this.$el.html(this.template({number:this.resultsNumber.get("number")})),this},t.prototype.onClose=function(){return this.remove()},t}(Backbone.View)}.call(this),function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}},r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.RegionChooserView=function(e){function r(){return this.triggerChooseRegion=t(this.triggerChooseRegion,this),r.__super__.constructor.apply(this,arguments)}return i(r,e),r.prototype.template=Handlebars.templates.region_chooser,r.prototype.className="modal region-chooser",r.prototype.events={"click .regions .region-area":"triggerChooseRegion"},r.prototype.initialize=function(e){return this.regions=e.regions,this.render()},r.prototype.render=function(){return this.$el.html(this.template({regions:this.regions.toJSON()})),this},r.prototype.triggerChooseRegion=function(e){var t,r;return r=$(e.target).attr("data-region-code"),t=this.regions.find(function(e){return e.get("code")===r}),this.trigger("regionChosen",t)},r.prototype.onClose=function(){},r}(Backbone.View)}.call(this),function(){var e,t={}.hasOwnProperty,r=function(e,r){function i(){this.constructor=e}for(var n in r)t.call(r,n)&&(e[n]=r[n]);return i.prototype=r.prototype,e.prototype=new i,e.__super__=r.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.ScenarioSelectorView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.template=Handlebars.templates.scenario_selector,t.prototype.events={"change #scenario-select":"setScenario"},t.prototype.initialize=function(e){return this.config=_.cloneDeep(MacArthur.CONFIG.scenarios),this.filter=e.filter,this.render()},t.prototype.render=function(){var e,t,r;return t=MacArthur.getFilterOptionsWithSelectedSet(this.filter,"scenario"),e=null!=this.filter.get("scenario")?!1:!0,this.$el.html(this.template({filter:this.filter,scenarios:t,defaultOption:e})),r=this.$el.find(".select-box"),setTimeout(function(e){return function(){return r.customSelect(),e.$el.find(".customSelectInner").css({width:"100%"})}}(this),20),this},t.prototype.onClose=function(){},t.prototype.setScenario=function(e){var t;return t=$(e.target).find(":selected").attr("value"),this.filter.set("scenario",t)},t}(Backbone.View)}.call(this),function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}},r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.LensSelectorView=function(e){function r(){return this.setDefaultLens=t(this.setDefaultLens,this),r.__super__.constructor.apply(this,arguments)}return i(r,e),r.prototype.template=Handlebars.templates.lens_selector,r.prototype.events={"change #lens-select":"setLens"},r.prototype.initialize=function(e){return this.config=_.cloneDeep(MacArthur.CONFIG.lenses),this.filter=e.filter,this.listenTo(this.filter,"change:subject",this.setDefaultLens),null==this.filter.get("lens")&&this.setDefaultLens(),this.render()},r.prototype.render=function(){var e,t,r;return t=this.filter.get("subject"),e=_.map(this.config[this.filter.get("subject")],function(e){return function(t){return t.selected=e.filter.get("lens")===t.selector?!0:!1,t}}(this)),this.$el.html(this.template({lenses:e,subject:t.charAt(0).toUpperCase()+t.slice(1)})),r=this.$el.find(".select-box"),setTimeout(function(e){return function(){return r.customSelect(),e.$el.find(".customSelectInner").css({width:"100%"})}}(this),20),this},r.prototype.setLens=function(e){var t;return t=$(e.target).find(":selected").attr("value"),this.filter.set("lens",t)},r.prototype.onClose=function(){return this.remove()},r.prototype.setDefaultLens=function(){return null!=this.filter.get("subject")?this.filter.set("lens",this.getDefaultFilter().selector):void 0},r.prototype.getDefaultFilter=function(){return _.find(this.config[this.filter.get("subject")],function(e){return null!=e["default"]})},r}(Backbone.View)}.call(this),function(){var e,t={}.hasOwnProperty,r=function(e,r){function i(){this.constructor=e}for(var n in r)t.call(r,n)&&(e[n]=r[n]);return i.prototype=r.prototype,e.prototype=new i,e.__super__=r.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.LevelSelectorAgrCommDevView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.template=Handlebars.templates.level_selector_agr_comm_dev,t.prototype.events={"change #agr-comm-select":"setLevel"},t.prototype.initialize=function(){return t.__super__.initialize.apply(this,arguments),this.config=_.cloneDeep(MacArthur.CONFIG.agrCommDevLevels),this.levelType="agrCommDevLevel",null==this.filter.get(this.levelType)&&this.setDefaultLevel(),this.render()},t}(Backbone.Views.BaseSelectorView)}.call(this),function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}},r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.LevelSelectorView=function(e){function r(){return this.setConfig=t(this.setConfig,this),r.__super__.constructor.apply(this,arguments)}return i(r,e),r.prototype.template=Handlebars.templates.level_selector,r.prototype.events={"change #levels-select":"setLevel"},r.prototype.initialize=function(){return r.__super__.initialize.apply(this,arguments),this.listenTo(this.filter,"change:tab",this.setConfig),this.setConfig(),this.levelType="level",null==this.filter.get("level")&&this.setDefaultLevel(),this.render()},r.prototype.setConfig=function(){var e;return e=MacArthur.CONFIG.levels[this.filter.get("tab")]||MacArthur.CONFIG.levels["default"],this.config=_.cloneDeep(e)},r}(Backbone.Views.BaseSelectorView)}.call(this),function(){var e,t={}.hasOwnProperty,r=function(e,r){function i(){this.constructor=e}for(var n in r)t.call(r,n)&&(e[n]=r[n]);return i.prototype=r.prototype,e.prototype=new i,e.__super__=r.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.PressureOptionView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.template=Handlebars.templates.pressure_option,t.prototype.events={'change [type="checkbox"]':"setPressure"},t.prototype.initialize=function(e){return this.filter=e.filter,this.pressure=this.filter.get("pressure"),this.render()},t.prototype.render=function(){return this.$el.html(this.template({thisView:this,filter:this.filter,pressure:!!this.pressure})),this.attachSubViews(),this},t.prototype.setPressure=function(e){return this.filter.set("pressure",$(e.target).is(":checked")),this.unsetPressureLevel()},t.prototype.unsetPressureLevel=function(){return this.filter.get("pressure")===!1?this.filter.unset("pressureLevel"):void 0},t.prototype.onClose=function(){return this.closeSubViews(),this.stopListening()},t}(Backbone.Diorama.NestingView)}.call(this),function(){var e,t={}.hasOwnProperty,r=function(e,r){function i(){this.constructor=e}for(var n in r)t.call(r,n)&&(e[n]=r[n]);return i.prototype=r.prototype,e.prototype=new i,e.__super__=r.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.PressureSelectorView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.template=Handlebars.templates.pressure_selector,t.prototype.events={"change #pressure-select":"setLevel"},t.prototype.initialize=function(){return t.__super__.initialize.apply(this,arguments),this.config=_.cloneDeep(MacArthur.CONFIG.pressureLevels),this.levelType="pressureLevel",null==this.filter.get(this.levelType)&&this.setDefaultLevel(),this.render()},t}(Backbone.Views.BaseSelectorView)}.call(this),function(){var e,t={}.hasOwnProperty,r=function(e,r){function i(){this.constructor=e}for(var n in r)t.call(r,n)&&(e[n]=r[n]);return i.prototype=r.prototype,e.prototype=new i,e.__super__=r.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.ProtectionOptionView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.template=Handlebars.templates.protection_option,t.prototype.events={'change [type="checkbox"]':"setProtection"},t.prototype.initialize=function(e){return this.filter=e.filter,this.protection=this.filter.get("protection"),this.render()},t.prototype.render=function(){return this.$el.html(this.template({thisView:this,filter:this.filter,protection:!!this.protection})),this.attachSubViews(),this},t.prototype.setProtection=function(e){return this.filter.set("protection",$(e.target).is(":checked")),this.unsetProtectionLevel()},t.prototype.unsetProtectionLevel=function(){return this.filter.get("protection")===!1?this.filter.unset("protectionLevel"):void 0},t.prototype.onClose=function(){return this.closeSubViews(),this.stopListening()},t}(Backbone.Diorama.NestingView)}.call(this),function(){var e,t={}.hasOwnProperty,r=function(e,r){function i(){this.constructor=e}for(var n in r)t.call(r,n)&&(e[n]=r[n]);return i.prototype=r.prototype,e.prototype=new i,e.__super__=r.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.ProtectionSelectorView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.template=Handlebars.templates.protection_selector,t.prototype.events={"change #protection-select":"setLevel"},t.prototype.initialize=function(){return t.__super__.initialize.apply(this,arguments),this.config=_.cloneDeep(MacArthur.CONFIG.protectionLevels),this.levelType="protectionLevel",null==this.filter.get(this.levelType)&&this.setDefaultLevel(),this.render()},t}(Backbone.Views.BaseSelectorView)}.call(this),function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}},r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};window.Backbone||(window.Backbone={}),(e=window.Backbone).Views||(e.Views={}),Backbone.Views.FilterView=function(e){function r(){return this.setSubject=t(this.setSubject,this),r.__super__.constructor.apply(this,arguments)}return i(r,e),r.prototype.template=Handlebars.templates.filter,r.prototype.events={"click .subjects li":"setSubject"},r.prototype.attributes={"class":"filters"},r.prototype.initialize=function(e){return this.filter=e.filter,this.resultsNumber=e.resultsNumber,this.listenTo(this.filter,"change",this.render),this.render()
},r.prototype.render=function(){var e;return e=MacArthur.getFilterOptionsWithSelectedSet(this.filter,"subject"),this.$el.html(this.template({thisView:this,subjects:e,showLensSelector:this.showLensSelector(),showScenarioGroup:this.showScenarioGroup(),showScenarioSelector:this.showScenarioSelector(),showOtherSelectors:this.showOtherSelectors(),showAgrCommDevSelector:this.showAgrCommDevSelector(),filter:this.filter,resultsNumber:this.resultsNumber})),this.attachSubViews(),this},r.prototype.setSubject=function(e){var t;return t=$(e.target).attr("data-subject"),this.filter.set("subject",t)},r.prototype.onClose=function(){return this.closeSubViews(),this.stopListening()},r.prototype.showLensSelector=function(){var e;return e=this.filter.get("tab"),"now"===e?null!=this.filter.get("subject"):"change"===e||"future_threats"===e?null!=this.filter.get("subject")&&null!=this.filter.get("scenario"):!1},r.prototype.showScenarioGroup=function(){var e;return e=this.filter.get("tab"),"future_threats"===e?!0:!1},r.prototype.showScenarioSelector=function(){var e;return e=this.filter.get("tab"),"change"===e||"future_threats"===e?null!=this.filter.get("subject"):!1},r.prototype.showAgrCommDevSelector=function(){return"future_threats"===this.filter.get("tab")&&this.showOtherSelectors()},r.prototype.showOtherSelectors=function(){var e;return e=this.filter.get("tab"),"now"===e?null!=this.filter.get("subject"):"change"===e||"future_threats"===e?null!=this.filter.get("subject")&&null!=this.filter.get("scenario"):!1},r}(Backbone.Diorama.NestingView)}.call(this),function(){var e,t,r=function(e,t){return function(){return e.apply(t,arguments)}},i={}.hasOwnProperty,n=function(e,t){function r(){this.constructor=e}for(var n in t)i.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};window.Backbone||(window.Backbone={}),(t=window.Backbone).Controllers||(t.Controllers={}),e=function(){function e(){this.disabler=$('<div class="disabler"></div>')}return e.prototype.showModal=function(e){return this.view=e,$("body").prepend(this.disabler),$("body").append(this.view.$el)},e.prototype.hideModal=function(){return $("body").find(".disabler").remove(),this.view.close()},e}(),Backbone.Controllers.MainController=function(t){function i(){this.showSidePanel=r(this.showSidePanel,this),this.getGeometries=r(this.getGeometries,this),this.chooseRegion=r(this.chooseRegion,this),this.showMap=r(this.showMap,this),this.regions=new Backbone.Collections.RegionCollection(MacArthur.CONFIG.regions),this.filter=new Backbone.Models.Filter,this.resultsNumber=new Backbone.Models.ResultsNumber,this.queryBuilder=new window.MacArthur.QueryBuilder(this.filter),this.modalContainer=new e,this.sidePanel=new Backbone.Diorama.ManagedRegion,this.sidePanel.$el.attr("id","side-panel"),this.sidePanel.$el.insertAfter("#map"),this.showMap(),this.chooseRegion()}return n(i,t),i.prototype.showMap=function(){return this.map=new Backbone.Views.MapView({filter:this.filter,resultsNumber:this.resultsNumber})},i.prototype.chooseRegion=function(){var e;return e=new Backbone.Views.RegionChooserView({regions:this.regions}),this.modalContainer.showModal(e),this.changeStateOn({event:"regionChosen",publisher:e,newState:_.partialRight(this.getGeometries,this.showSidePanel)})},i.prototype.getGeometries=function(e,t){var r;return r=e.get("code"),$.getJSON("../../../data/"+r+".topo.json",function(){return function(r){return t(null,r,e)}}(this))},i.prototype.showSidePanel=function(e,t,r){var i;return this.modalContainer.hideModal(),this.filter.set({region:r}),i=new Backbone.Views.TabView({filter:this.filter,resultsNumber:this.resultsNumber}),this.sidePanel.showView(i),this.map.initQueryLayer(t,r)},i}(Backbone.Diorama.Controller)}.call(this);